{% extends 'shop/layouts/main.html' %}
{% block title %}ShopKart | {{ category_name }}{% endblock %}
{% block content %}
{% load static %}

<section class="bg-light py-5 my-4">
  <div class="container">
    {% comment %}  Heading  {% endcomment %}
    <div class="row mb-4">
      <div class="col-12">
        <h4 class="text-white bg-dark px-3 py-2 d-inline-block" style="border-radius:10px;">{{ category_name }} <i class="fas fa-box"></i></h4>
        <hr style="border-color:#404141;">
         <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                  <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
                  <li class="breadcrumb-item"><a href="{% url 'collections'  %}">Collections</a></li>
                  <li class="breadcrumb-item active" aria-current="page">{{ category_name }}</li>
                </ol>
              </nav>
      </div>
    </div>

    {% comment %} <!-- Search & Sort --> {% endcomment %}
    <div class="row mb-3">
      <div class="col-md-6">
        <input type="text" id="searchInput" class="form-control border shadow-sm" placeholder="Search products...">
      </div>
      <div class="col-md-4">
        <select id="sortSelect" class="form-control border shadow-sm">
          <option value="">Sort By</option>
          <option value="new_price">Price: Low to High</option>
          <option value="-new_price">Price: High to Low</option>
          <option value="name">Name A-Z</option>
          <option value="-name">Name Z-A</option>
        </select>
      </div>
    </div>

    {% comment %} Product Grid  {% endcomment %}
    <div class="row" id="productContainer">
      {% for item in prod %}

     <div class="col-md-4 col-lg-3">
          <div class="card my-3 trendy" style="border: none; box-shadow: 2px 3px 4px 2px #807f7f3b;">
              {% if item.product_image %}
                  <img src="{{ item.product_image.url }}" class="card-image-top mx-auto d-block" alt="{{item.name}} logo" style="width:150px;height:160px;margin-top: 3%;">
              {% else %}
                  <img src="{% static 'images/tick.jpeg' %}" class="card-image-top mx-auto d-block" alt="default image" style="width:150px;height:160px;margin-top: 3%;">
              {% endif %}
              <hr style="border-color: #404141;margin:2% 0 0 0;">
              <a href="{% url 'product_details' item.category item.name %}" style="color:initial;">
                  <div class="card-body">
                      <h5 class="card-title text-primary" style="padding-bottom:6px;">{{item.name}}</h5>
                      <p class="card-text">
                          <span class="float-start old_price"><s>₹{{item.old_price |stringformat:'d'}} </s></span>
                          <span class="float-end new_price">₹{{item.new_price |stringformat:'d'}}</span>
                      </p>
                  </div>
              </a>
          </div>
      </div>



      {% empty %}
      <div class="col-12"><p>No products found.</p></div>
      {% endfor %}
    </div>

    {% comment %}  Pagination {% endcomment %}
    <nav class="mt-3">
      <ul class="pagination justify-content-center" id="pagination">
        {% if prod.has_previous %}
        <li class="page-item"><a class="page-link" href="#" data-page="{{ prod.previous_page_number }}">Previous</a></li>
        {% endif %}
        {% for num in prod.paginator.page_range %}
        <li class="page-item {% if prod.number == num %}active{% endif %}">
          <a class="page-link" href="#" data-page="{{ num }}">{{ num }}</a>
        </li>
        {% endfor %}
        {% if prod.has_next %}
        <li class="page-item"><a class="page-link" href="#" data-page="{{ prod.next_page_number }}">Next</a></li>
        {% endif %}
      </ul>
    </nav>
  </div>
</section>

{% comment %} <!-- AJAX Script --> {% endcomment %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const productContainer = document.getElementById("productContainer");
    const pagination = document.getElementById("pagination");
    const searchInput = document.getElementById("searchInput");
    const sortSelect = document.getElementById("sortSelect");

    let currentPage = 1;

    function fetchProducts(page = 1) {
      const search = searchInput.value;
      const sort = sortSelect.value;

      const url = new URL(window.location.href);
      url.searchParams.set("page", page);
      if (search) url.searchParams.set("search", search);
      if (sort) url.searchParams.set("sort", sort);

      fetch(url, {
        headers: { "X-Requested-With": "XMLHttpRequest" }
      })
        .then(response => response.json())
        .then(data => {
          productContainer.innerHTML = "";
          if (data.products.length === 0) {
            productContainer.innerHTML = `<div class="col-12"><p>No products found.</p></div>`;
          } else {
            data.products.forEach(item => {
              const productHTML = `
              <div class="col-md-4 col-lg-3">
          <div class="card my-3 trendy" style="border: none; box-shadow: 2px 3px 4px 2px #807f7f3b;">
              
                  <img src="${item.image_url}" class="card-image-top mx-auto d-block" alt="${item.name} logo" style="width:150px;height:160px;margin-top: 3%;">
              <hr style="border-color: #404141;margin:2% 0 0 0;">
              <a href="${item.details_url}" style="color:initial;">
                  <div class="card-body">
                       <h5 class="card-title text-primary" style="padding-bottom:6px;">${item.name}</h5>
                      <p class="card-text">
                          <span class="float-start old_price"><s>₹${item.old_price}</s></span>
                          <span class="float-end new_price">₹${item.new_price}</span>
                      </p>
                  </div>
              </a>
          </div>
      </div>
                
              `;
              productContainer.insertAdjacentHTML("beforeend", productHTML);
            });
          }

          updatePagination(data);
        });
    }

    function updatePagination(data) {
      pagination.innerHTML = "";

      if (data.has_previous) {
        pagination.innerHTML += `
          <li class="page-item"><a class="page-link" href="#" data-page="${data.current_page - 1}">Previous</a></li>
        `;
      }

      for (let i = 1; i <= data.num_pages; i++) {
        pagination.innerHTML += `
          <li class="page-item ${data.current_page === i ? 'active' : ''}">
            <a class="page-link" href="#" data-page="${i}">${i}</a>
          </li>
        `;
      }

      if (data.has_next) {
        pagination.innerHTML += `
          <li class="page-item"><a class="page-link" href="#" data-page="${data.current_page + 1}">Next</a></li>
        `;
      }

      attachPaginationEvents();
    }

    function attachPaginationEvents() {
      pagination.querySelectorAll(".page-link").forEach(link => {
        link.addEventListener("click", function (e) {
          e.preventDefault();
          const page = parseInt(this.getAttribute("data-page"));
          if (!isNaN(page)) {
            currentPage = page;
            fetchProducts(currentPage);
          }
        });
      });
    }

    // Live event listeners
    searchInput.addEventListener("input", () => fetchProducts(1));
    sortSelect.addEventListener("change", () => fetchProducts(1));

    // Initial fetch
    fetchProducts(currentPage);
  });
</script>

{% endblock %}
